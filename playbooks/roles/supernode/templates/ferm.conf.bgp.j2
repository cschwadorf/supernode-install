domain (ip ip6) {
    table filter {
        chain INPUT {
            policy ACCEPT;
            proto gre ACCEPT;
            mod state state INVALID DROP;
            mod state state (ESTABLISHED RELATED) ACCEPT;
            interface lo ACCEPT;
            proto icmp ACCEPT;
            proto udp dport 500 ACCEPT;
            proto (esp) ACCEPT;
            proto tcp dport ( ssh http https ) ACCEPT;
        }
        chain OUTPUT {
            policy ACCEPT;
            outerface {{ ansible_default_ipv4.alias }} daddr 10.0.0.0/8 DROP;
            outerface {{ ansible_default_ipv4.alias }} daddr 169.254.0.0/16 DROP;
            outerface {{ ansible_default_ipv4.alias }} daddr 172.16.0.0/12 DROP; 
            outerface {{ ansible_default_ipv4.alias }} daddr 192.168.0.0/16 DROP; 
            mod state state (ESTABLISHED RELATED) ACCEPT;
        }
        chain FORWARD {
            policy ACCEPT;
            mod state state INVALID DROP;
            mod state state (ESTABLISHED RELATED) ACCEPT;
        }
    }
    table mangle {
        chain PREROUTING {
            interface {{ supernode.tun_prefix }}+ {
                MARK set-mark 4;
            }
        }
        chain POSTROUTING {
            outerface {{ supernode.tun_prefix }}+ proto tcp tcp-flags (SYN RST) SYN TCPMSS clamp-mss-to-pmtu;
        }
    }
    table nat {
        chain POSTROUTING {
            outerface {{ ansible_default_ipv4.alias }} MASQUERADE;
            outerface {{ supernode.tun_prefix }}+ saddr {{ supernode.mesh.IPv4_net }}/{{ supernode.mesh.IPv4_CIDR }} SNAT to {{ ffrl.IPv4 }};
            policy ACCEPT;
        }
    }
}
