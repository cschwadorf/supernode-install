---
# file: playbooks/roles/gateways/tasks/tsk_tunneldigger.yaml
#
# Thomas Arend
# Date 2019-04-13
#
#

# Install and configure tunneldigger

- name: Get Tunneldigger
  git: 
    repo: https://github.com/freifunk-voreifel/tunneldigger.git
    dest: /srv/tunneldigger
  register: tunneldigger
  tags: 
    - tunneldigger

- name: Stop tunneldigger
  service:
    name: tunneldigger
    state: stopped
  ignore_errors: True
  tags: 
    - tunneldigger

- name: Configure tunneldigger
  raw: "cd /srv/tunneldigger && virtualenv env_tunneldigger && source env_tunneldigger/bin/activate && cd broker && python setup.py install"
  tags: 
    - tunneldigger

- name: Copy l2tp broker config template
  template: 
    src: "{{ item }}.j2"
    dest: "/srv/tunneldigger/{{ item }}"
    owner: root
    group: root
    mode: 0444
  loop: "{{ broker_cfg }}"
  tags: 
    - tunneldigger

- name: Copy tunneldigger bataddif
  template: 
    src: bataddif.sh.j2
    dest: /srv/tunneldigger/bataddif.sh
    owner: root 
    group: root
    mode: 0500
  tags: 
    - tunneldigger

- name: Copy tunneldigger scripts
  copy: 
    src: "{{ item }}"
    dest: /srv/tunneldigger
    owner: root
    group: root
    mode: 0500
  loop: "{{ tunneldigger_scripts }}"
  tags: 
    - tunneldigger

- name: Copy tunneldigger service template
  copy: 
    src: "{{ item }}"
    dest: /etc/systemd/system
    owner: root
    group: root
    mode: 0444
  tags: 
    - tunneldigger
  loop: "{{ tunneldigger_service }}"

- name: Tunneldigger reload
  command: systemctl daemon-reload
  tags: 
    - tunneldigger

- name: Enable and restart service tunneldigger
  service:
    name: tunneldigger
    enabled: yes
    state: restarted
  tags: 
    - tunneldigger

- name: Copy backbone script
  template: 
    src: l2tp_backbone.sh.exit.j2 
    dest: /opt/freifunk/l2tp_backbone.sh
    owner: root
    group: root
    mode: 0755
  tags: 
    - tunneldigger

- name: Add cron backbone script
  cron: 
    name: backbone 
    special_time: reboot
    job: "/opt/freifunk/l2tp_backbone.sh"
  tags: 
    - tunneldigger
...

